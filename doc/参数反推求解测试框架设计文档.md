# 参数反推求解测试框架设计文档

## 1. 概述

### 1.1 设计目标
设计一个自动化测试框架，用于验证约束算法类的参数反推求解功能。该框架能够根据约束算法类的注解自动生成测试数据，并提供完整的测试执行和结果验证能力。

### 1.2 核心功能
- 根据约束算法类的注解，自动生成Module数据
- 自动初始化执行引擎和基础数据
- 提供流水结果比较框架，简化测试代码编写

### 1.3 使用流程
1. 手工创建约束算法类，如`HelloConstraint`
2. 手工创建对应的测试类，继承测试框架：如`HelloConstraintTest`
3. 手工补充测试用例（使用`ModuleSecnarioTestBase`的assert方法等）

## 2. 架构设计

### 2.1 整体架构
```
测试框架基类 (ModuleSecnarioTestBase)
    ↓
注解处理器 (ModuleGenneratorByAnno)
    ↓
约束执行引擎 (ModuleConstraintExecutorImpl)
    ↓
结果验证器 (ProgammableInstAssert)
```

### 2.2 核心组件
- **测试框架基类**: 提供测试基础设施和通用方法
- **注解处理器**: 解析注解并生成Module数据
- **结果验证器**: 提供链式断言API进行结果验证

## 3. 详细设计

### 3.1 测试框架基类设计

#### 3.1.1 类结构
```java
public abstract class ModuleSecnarioTestBase {
    // 核心属性
    protected Class<? extends ConstraintAlg> constraintAlgClazz;
    protected String tempResourcePath = "";
    protected Module module;
    protected ModuleConstraintExecutor.ConstraintConfig cfg;
    protected ModuleConstraintExecutorImpl exec;
    protected List<ModuleConstraintExecutor.ModuleInst> solutions;
    
    // 构造函数
    public ModuleSecnarioTestBase(Class<? extends ConstraintAlg> constraintAlgClazz) {
        this.constraintAlgClazz = constraintAlgClazz;
    }
}
```

#### 3.1.2 核心方法
```java
// 构建Module数据
protected Module buildModule(Class<? extends ConstraintAlg> moduleAlgClazz) {
    // 生成临时资源路径
    tempResourcePath = getResourcePath(moduleAlgClazz) + "/tempResource";
    createDirectory(tempResourcePath);
    
    // 通过注解生成Module
    module = ModuleGenneratorByAnno.build(moduleAlgClazz, tempResourcePath);
    return module;
}

// 初始化测试环境
protected void init() {
    exec = new ModuleConstraintExecutorImpl();
    cfg = new ModuleConstraintExecutor.ConstraintConfig();
    cfg.isAttachedDebug = true;
    cfg.rootFilePath = tempResourcePath;
    exec.init(cfg);
    
    module = buildModule(this.constraintAlgClazz);
    exec.addModule(module.getId(), module);
}

// 执行参数推理
protected List<ModuleConstraintExecutor.ModuleInst> inferParas(String partCode, Integer qty) {
    ModuleConstraintExecutor.InferParasReq req = new ModuleConstraintExecutor.InferParasReq();
    req.moduleId = module.getId();
    req.enumerateAllSolution = true;
    
    ModuleConstraintExecutor.Result<List<ModuleConstraintExecutor.ModuleInst>> r = exec.inferParas(req);
    log.info("推理结果: {}", r);
    
    solutions = r.data;
    return solutions;
}

// 获取指定索引的解决方案
protected ProgammableInstAssert solution(int index) {
    if (solutions == null || index >= solutions.size()) {
        throw new IndexOutOfBoundsException("解决方案索引超出范围: " + index);
    }
    ModuleConstraintExecutor.ModuleInst solution = solutions.get(index);
    return new ProgammableInstAssert(solution);
}

// 打印所有解决方案
protected void printSolutions() {
    if (solutions == null || solutions.isEmpty()) {
        log.info("没有找到解决方案");
        return;
    }
    
    log.info("找到 {} 个解决方案:", solutions.size());
    for (int i = 0; i < solutions.size(); i++) {
        log.info("解决方案 {}: {}", i, ModuleConstraintExecutorImpl.toJson(solutions.get(i)));
    }
}
```

### 3.2 注解处理器设计

#### 3.2.1 核心注解定义

##### ModuleAnno注解
```java
@Target(ElementType.TYPE)
@Retention(RetentionPolicy.RUNTIME)
public @interface ModuleAnno {
    /**
     * 模块ID
     */
    Long id();
    
    /**
     * 模块编码
     */
    String code() default "";
    
    /**
     * 包名
     */
    String packageName() default "";
    
    /**
     * 版本号
     */
    String version() default "1.0.0";
    
    /**
     * 描述信息
     */
    String description() default "";
    
    /**
     * 排序号
     */
    Integer sortNo() default 0;
    
    /**
     * 扩展模式
     */
    String extSchema() default "";
    
    /**
     * 扩展属性
     */
    String[] extAttrs() default {};
}
```

##### ParaAnno注解
```java
@Target(ElementType.FIELD)
@Retention(RetentionPolicy.RUNTIME)
public @interface ParaAnno {
    /**
     * 参数编码
     */
    String code() default "";
    
    /**
     * 父对象编码
     */
    String fatherCode() default "";
    
    /**
     * 默认值
     */
    String defaultValue() default "";
    
    /**
     * 描述信息
     */
    String description() default "";
    
    /**
     * 排序号
     */
    Integer sortNo() default 0;
    
    /**
     * 参数类型
     */
    ParaType type() default ParaType.ENUM;
    
    /**
     * 枚举选项代码列表
     */
    String[] options() default {};
    
    /**
     * 最小值（Range类型）
     */
    String minValue() default "";
    
    /**
     * 最大值（Range类型）
     */
    String maxValue() default "";
    
    /**
     * 扩展模式
     */
    String extSchema() default "";
    
    /**
     * 扩展属性
     */
    String[] extAttrs() default {};
}
```

##### PartAnno注解
```java
@Target(ElementType.FIELD)
@Retention(RetentionPolicy.RUNTIME)
public @interface PartAnno {
    /**
     * 部件编码
     */
    String code() default "";
    
    /**
     * 父对象编码
     */
    String fatherCode() default "";
    
    /**
     * 默认值
     */
    String defaultValue() default "";
    
    /**
     * 描述信息
     */
    String description() default "";
    
    /**
     * 排序号
     */
    Integer sortNo() default 0;
    
    /**
     * 部件类型
     */
    PartType type() default PartType.ATOMIC;
    
    /**
     * 价格
     */
    Long price() default 0L;
    
    /**
     * 规格属性
     */
    String[] attrs() default {};
    
    /**
     * 扩展模式
     */
    String extSchema() default "";
    
    /**
     * 扩展属性
     */
    String[] extAttrs() default {};
}
```

#### 3.2.2 Module生成器实现
```java
public class ModuleGenneratorByAnno {
    
    public static Module build(Class<? extends ConstraintAlg> moduleAlgClazz, String resourcePath) {
        Module module = new Module();
        
        // 1. 根据ModuleAnno信息创建Module
        ModuleAnno moduleAnno = moduleAlgClazz.getAnnotation(ModuleAnno.class);
        if (moduleAnno != null) {
            // 1.1 生成Module.code
            String className = moduleAlgClazz.getSimpleName();
            String code = className.replace("Constraint", "");
            module.setCode(code);
            
            // 1.2 设置其他属性
            module.setId(moduleAnno.id());
            module.setPackageName(moduleAnno.packageName().isEmpty() ? 
                moduleAlgClazz.getPackage().getName() : moduleAnno.packageName());
            module.setVersion(moduleAnno.version());
            module.setDescription(moduleAnno.description());
            module.setSortNo(moduleAnno.sortNo());
            module.setExtSchema(moduleAnno.extSchema());
            
            // 处理扩展属性
            if (moduleAnno.extAttrs().length > 0) {
                Map<String, String> extAttrs = new HashMap<>();
                for (String attr : moduleAnno.extAttrs()) {
                    String[] parts = attr.split(":");
                    if (parts.length == 2) {
                        extAttrs.put(parts[0], parts[1]);
                    }
                }
                module.setExtAttrs(extAttrs);
            }
        }
        
        // 2. 遍历成员变量，创建Para和Part
        List<Para> paras = new ArrayList<>();
        List<Part> parts = new ArrayList<>();
        
        for (Field field : moduleAlgClazz.getDeclaredFields()) {
            if (ParaVar.class.isAssignableFrom(field.getType())) {
                Para para = createParaFromField(field);
                if (para != null) {
                    paras.add(para);
                }
            } else if (PartVar.class.isAssignableFrom(field.getType())) {
                Part part = createPartFromField(field);
                if (part != null) {
                    parts.add(part);
                }
            }
        }
        
        module.setParas(paras);
        module.setParts(parts);
        
        // 3. 保存Module到文件
        String fileName = module.getCode() + ".base.json";
        ModuleUtils.toJsonFile(module, resourcePath + "/" + fileName);
        
        return module;
    }
    
    private static Para createParaFromField(Field field) {
        ParaAnno paraAnno = field.getAnnotation(ParaAnno.class);
        if (paraAnno == null) return null;
        
        Para para = new Para();
        
        // 生成Para.code
        String fieldName = field.getName();
        String code = fieldName.replace("Var", "");
        para.setCode(code);
        
        // 设置其他属性
        para.setFatherCode(paraAnno.fatherCode());
        para.setDefaultValue(paraAnno.defaultValue());
        para.setDescription(paraAnno.description());
        para.setSortNo(paraAnno.sortNo());
        para.setType(paraAnno.type());
        para.setExtSchema(paraAnno.extSchema());
        
        // 处理扩展属性
        if (paraAnno.extAttrs().length > 0) {
            Map<String, String> extAttrs = new HashMap<>();
            for (String attr : paraAnno.extAttrs()) {
                String[] parts = attr.split(":");
                if (parts.length == 2) {
                    extAttrs.put(parts[0], parts[1]);
                }
            }
            para.setExtAttrs(extAttrs);
        }
        
        // 处理枚举选项
        if (paraAnno.options().length > 0) {
            List<ParaOption> options = new ArrayList<>();
            for (int i = 0; i < paraAnno.options().length; i++) {
                ParaOption option = new ParaOption();
                option.setCode(paraAnno.options()[i]);
                option.setCodeId((i + 1) * 10); // 10, 20, 30...
                option.setDefaultValue(paraAnno.options()[i]);
                option.setDescription("");
                option.setSortNo(i + 1);
                options.add(option);
            }
            para.setOptions(options);
        }
        
        return para;
    }
    
    private static Part createPartFromField(Field field) {
        PartAnno partAnno = field.getAnnotation(PartAnno.class);
        if (partAnno == null) return null;
        
        Part part = new Part();
        
        // 生成Part.code
        String fieldName = field.getName();
        String code = fieldName.replace("Var", "");
        part.setCode(code);
        
        // 设置其他属性
        part.setFatherCode(partAnno.fatherCode());
        part.setDefaultValue(partAnno.defaultValue());
        part.setDescription(partAnno.description());
        part.setSortNo(partAnno.sortNo());
        part.setType(partAnno.type());
        part.setPrice(partAnno.price());
        part.setExtSchema(partAnno.extSchema());
        
        // 处理规格属性
        if (partAnno.attrs().length > 0) {
            Map<String, String> attrs = new HashMap<>();
            for (String attr : partAnno.attrs()) {
                String[] parts = attr.split(":");
                if (parts.length == 2) {
                    attrs.put(parts[0], parts[1]);
                }
            }
            part.setAttrs(attrs);
        }
        
        // 处理扩展属性
        if (partAnno.extAttrs().length > 0) {
            Map<String, String> extAttrs = new HashMap<>();
            for (String attr : partAnno.extAttrs()) {
                String[] parts = attr.split(":");
                if (parts.length == 2) {
                    extAttrs.put(parts[0], parts[1]);
                }
            }
            part.setExtAttrs(extAttrs);
        }
        
        return part;
    }
}
```

### 3.3 结果验证器设计

#### 3.3.1 基础断言类
```java
public class ProgammableInstAssert {
    protected ModuleConstraintExecutor.ModuleInst actualModuleInst;
    
    public ProgammableInstAssert(ModuleConstraintExecutor.ModuleInst actualModuleInst) {
        this.actualModuleInst = actualModuleInst;
    }
    
    public ParaInstAssert assertPara(String code) {
        ParaInst paraInst = findParaByCode(code);
        if (paraInst == null) {
            throw new AssertionError("未找到参数: " + code);
        }
        return new ParaInstAssert(paraInst);
    }
    
    public PartInstAssert assertPart(String code) {
        PartInst partInst = findPartByCode(code);
        if (partInst == null) {
            throw new AssertionError("未找到部件: " + code);
        }
        return new PartInstAssert(partInst);
    }
    
    private ParaInst findParaByCode(String code) {
        if (actualModuleInst.paras == null) return null;
        return actualModuleInst.paras.stream()
            .filter(p -> code.equals(p.code))
            .findFirst()
            .orElse(null);
    }
    
    private PartInst findPartByCode(String code) {
        if (actualModuleInst.parts == null) return null;
        return actualModuleInst.parts.stream()
            .filter(p -> code.equals(p.code))
            .findFirst()
            .orElse(null);
    }
}
```

#### 3.3.2 参数断言类
```java
public class ParaInstAssert extends ProgammableInstAssert {
    private ParaInst actual;
    
    public ParaInstAssert(ParaInst actual) {
        super(null);
        this.actual = actual;
    }
    
    public ParaInstAssert valueEqual(String expectValue) {
        if (!Objects.equals(actual.value, expectValue)) {
            throw new AssertionError(String.format(
                "参数值不匹配，期望: %s，实际: %s", expectValue, actual.value));
        }
        return this;
    }
    
    public ParaInstAssert valueNotEqual(String expectValue) {
        if (Objects.equals(actual.value, expectValue)) {
            throw new AssertionError(String.format(
                "参数值不应等于: %s", expectValue));
        }
        return this;
    }
    
    public ParaInstAssert optionsEqual(String... expectOptions) {
        if (actual.options == null) {
            throw new AssertionError("参数选项为空");
        }
        
        Set<String> actualOptions = new HashSet<>(actual.options);
        Set<String> expectedOptions = new HashSet<>(Arrays.asList(expectOptions));
        
        if (!actualOptions.containsAll(expectedOptions)) {
            throw new AssertionError(String.format(
                "参数选项不匹配，期望包含: %s，实际: %s", 
                Arrays.toString(expectOptions), actual.options));
        }
        return this;
    }
    
    public ParaInstAssert hiddenEqual(boolean expectHidden) {
        if (actual.isHidden != expectHidden) {
            throw new AssertionError(String.format(
                "参数隐藏状态不匹配，期望: %s，实际: %s", expectHidden, actual.isHidden));
        }
        return this;
    }
}
```

#### 3.3.3 部件断言类
```java
public class PartInstAssert extends ProgammableInstAssert {
    private PartInst actual;
    
    public PartInstAssert(PartInst actual) {
        super(null);
        this.actual = actual;
    }
    
    public PartInstAssert quantityEqual(Integer expectQuantity) {
        if (!Objects.equals(actual.quantity, expectQuantity)) {
            throw new AssertionError(String.format(
                "部件数量不匹配，期望: %s，实际: %s", expectQuantity, actual.quantity));
        }
        return this;
    }
    
    public PartInstAssert quantityGreaterThan(Integer minQuantity) {
        if (actual.quantity == null || actual.quantity <= minQuantity) {
            throw new AssertionError(String.format(
                "部件数量应大于: %s，实际: %s", minQuantity, actual.quantity));
        }
        return this;
    }
    
    public PartInstAssert hiddenEqual(boolean expectHidden) {
        if (actual.isHidden != expectHidden) {
            throw new AssertionError(String.format(
                "部件隐藏状态不匹配，期望: %s，实际: %s", expectHidden, actual.isHidden));
        }
        return this;
    }
}
```

## 4. 样例数据

### 4.1 约束算法类样例
```java
@ModuleAnno(
    id = 123L,
    code = "Hello",
    packageName = "com.jmix.configengine.scenario.hello",
    description = "Hello模块约束算法",
    extSchema = "HelloModuleSchema"
)
public class HelloConstraint extends ConstraintAlgImpl {
    
    @ParaAnno(
        code = "Color",
        fatherCode = "Hello",
        defaultValue = "Red",
        description = "颜色参数",
        options = {"Red", "Black", "White"},
        extAttrs = {"category:color", "required:true"}
    )
    private ParaVar ColorVar;
    
    @PartAnno(
        code = "TShirt11",
        fatherCode = "Hello",
        description = "T恤衫主体部件",
        price = 100L,
        attrs = {"weight:180g", "size:M"},
        extAttrs = {"material:cotton", "brand:Hello"}
    )
    private PartVar TShirt11Var;
}
```

### 4.2 测试类样例
```java
public class HelloConstraintTest extends ModuleSecnarioTestBase {
    
    public HelloConstraintTest() {
        super(HelloConstraint.class);
    }
    
    @Before
    public void setUp() {
        init();
    }
    
    @Test
    public void testColorParameterInference() {
        // 测试颜色参数推理
        inferParas("TShirt11", 1);
        
        // 验证第一个解决方案
        solution(0)
            .assertPara("Color